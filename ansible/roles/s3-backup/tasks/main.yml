---

- name: install Duplicity
  become: yes
  apt:
    name: "{{ item }}"
    update_cache: yes
    cache_valid_time: "{{ apt_cache_valid_time }}"
  with_items:
    - duplicity
    - s3cmd
    - python
    - python-boto
    - cron

- name: install duplicity-backup.sh
  become: yes
  git:
    repo: "{{ s3_backup_duplicity_backup_sh_git_repository }}"
    dest: "{{ s3_backup_duplicity_backup_sh_install_directory }}"
    version: "{{ s3_backup_duplicity_backup_sh_version }}"

- name: setup duplicity-backup.sh installation
  become: yes
  file:
    src: "{{ s3_backup_duplicity_backup_sh_install_directory }}/{{ s3_backup_duplicity_backup_sh_script_name }}"
    dest: "/usr/local/bin/{{ s3_backup_duplicity_backup_sh_script_name }}"
    state: link

- name: create configuration directory
  become: yes
  file:
    path: "{{ s3_backup_configuration_directory }}"
    state: directory

- name: create s3cmd configuration file
  become: yes
  template:
    src: s3cmd.ini.j2
    dest: "{{ s3_backup_s3cmd_configuration_file }}"

- name: create duplicity-backup.sh configuration file
  become: yes
  template:
    src: duplicity-backup-sh.conf.j2
    dest: "{{ s3_backup_duplicity_backup_sh_configuration_file }}"

- name: schedule backup using cron
  become: yes
  cron:
    special_time: "{{ s3_backup_time }}"
    job: "duplicity-backup.sh -c {{ s3_backup_duplicity_backup_sh_configuration_file }} -b"
