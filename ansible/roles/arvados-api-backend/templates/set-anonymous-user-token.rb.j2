#!/usr/bin/env ruby
# Copyright 2017 Genome Research Ltd.
# Copyright (C) The Arvados Authors. All rights reserved.
#
# SPDX-License-Identifier: AGPL-3.0

# Set an anonymous user token to the token value hardcoded into this file.
# This script was generated by ansible.

require 'trollop'

opts = Trollop::options do
  banner ''
  banner "Usage: set_anonymous_user_token"
  banner ''
end

api_token = '{{ arvados_cluster_anonymous_api_token }}'

require File.dirname(__FILE__) + '/../config/environment'

include ApplicationHelper
act_as_system_user

def create_api_client_auth
  api_client_auth = ApiClientAuthorization.
    new(user: anonymous_user,
        api_client_id: 0,
        expires_at: Time.now + 100.years,
        scopes: ['GET /'],
        api_token: api_token)
  api_client_auth.save!
  api_client_auth.reload
end

if get_existing
  api_client_auth = ApiClientAuthorization.
    where('user_id=?', anonymous_user.id.to_i).
    where('expires_at>?', Time.now).
    where('api_token=?', api_token).
    select { |auth| auth.scopes == ['GET /'] }.
    first
end

# either not a get or no api_client_auth was found
if !api_client_auth
  api_client_auth = create_api_client_auth
end

exit 0
